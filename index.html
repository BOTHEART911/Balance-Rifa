<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>BALANCE RIFA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{ --primary:#3f37c9; --ok:#16a34a; --error:#dc2626; --chip:#0b5ed7; }
    html,body{ margin:0; padding:0; background:#f4f5fb; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#111; }
    .container{ max-width:720px; margin:0 auto; padding:16px; }
    h1{ text-align:center; color:#2a26a8; text-shadow:0 2px 2px #03173222; margin:10px 0 14px; letter-spacing:.5px; }

    /* Resumen de N° seleccionados + filtro (dos campos centrados) */
    .summary-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      margin:6px 0 12px;
    }

    .summary-row{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
      width:100%;
    }

    /* Grupo que contiene el badge y su caption (caption debajo del badge) */
    .selected-group{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      min-width:120px;
    }

    .selected-badge{
      display:inline-block;
      border-radius:999px; padding:8px 14px;
      font-weight:900; text-align:center;
      color:#0a0; background:#d7f8e3; border:3px solid #7adf9b; box-shadow:0 4px 10px rgba(0,0,0,.12);
      min-width:120px; max-width:92%;
      word-break:break-word; line-height:1.15;
    }
    .summary-caption{
      font-size:.85rem; color:#666; text-align:center;
    }

    /* Nuevo campo de filtro (blanco ovalado con borde negro) */
    .filter-input{
      appearance:none;
      border-radius:999px;
      background:#fff;
      border:3px solid #111;
      padding:10px 16px;
      font-weight:700;
      min-width:220px;
      max-width:360px;
      box-shadow:0 8px 18px rgba(0,0,0,.08);
      outline:none;
      font-size:0.95rem;
    }
    .filter-input::placeholder{ color:#999; font-weight:600; }

    .card{ background:#e9e9ef; border:3px solid var(--primary); border-radius:20px; padding:12px 14px 10px; box-shadow:0 6px 14px rgba(0,0,0,.10); margin:10px 0; }
    .row{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; margin-bottom:6px; }
    .name{ font-weight:900; font-size:1.15rem; color:#1b2a6b; }
    .datetime{ color:#444; font-weight:700; white-space:nowrap; font-size:.9rem; }
    .nums{ display:flex; flex-wrap:wrap; align-items:center; gap:0; margin:4px 0 10px; }
    .num-chip{ display:inline-flex; align-items:center; justify-content:center; background:var(--chip); color:#fff; min-width:26px; height:26px; padding:0 8px; border-radius:6px; border:2px solid #0a53be; font-weight:800; box-shadow:0 2px 6px rgba(0,0,0,.12); }
    .num-sep{ display:inline-block; margin:0 6px; color:#2a26a8; font-weight:900; user-select:none; }
    .actions{ display:flex; gap:10px; align-items:center; margin-top:4px; }

    .status-btn{ border-radius:999px; padding:10px 18px; font-weight:900; cursor:pointer; min-width:150px; background:#fff; border:3px solid #111; box-shadow:0 4px 10px rgba(0,0,0,.12); }
    .status-pending{ border-color:var(--error); color:#e11; background:#fff; }
    .status-pending::before{ content:"PENDIENTE"; }
    .status-paid{ border-color:#7adf9b; color:#0a0; background:#d7f8e3; }
    .status-paid::before{ content:"PAGO"; }

    .liberar-btn{ border-radius:999px; padding:10px 18px; font-weight:900; cursor:pointer; min-width:150px; background:#fff; color:#111; border:3px solid #111; box-shadow:0 4px 10px rgba(0,0,0,.12); }

    /* Grupo de íconos a la derecha (cobrar + whatsapp) */
    .actions-right{
      margin-left:auto; display:flex; gap:10px; align-items:center;
    }

    /* Botones de acción por WhatsApp (mismo tamaño) */
    .wa, .charge{
      display:inline-flex; align-items:center; justify-content:center;
      width:42px; height:42px; border-radius:10px; border:2px solid #25D366; background:#fff; box-shadow:0 6px 12px rgba(0,0,0,.18);
    }
    .wa img, .charge img{ width:28px; height:28px; object-fit:contain; border-radius:6px; background:#fff; }

    .save-wrap{ display:flex; justify-content:center; margin:12px 0 30px; }
    .save-btn{ border-radius:999px; padding:12px 20px; font-weight:900; cursor:pointer; min-width:220px; background:#fff; color:#111; border:3px solid #111; box-shadow:0 10px 20px rgba(0,0,0,.14); }
    .save-btn[disabled]{ opacity:.55; cursor:not-allowed; }

    /* Loader overlay con spin */
    .loader{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:9999; }
    .loader.active{ display:flex; }
    .spinner{ width:60px; height:60px; border-radius:50%; border:6px solid #fff; border-top-color:var(--primary); animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    @media (max-width:720px){
      .selected-badge{ max-width:40%; min-width:90px; }
      .filter-input{ max-width:55%; min-width:160px; }
    }
    @media (max-width:420px){
      .summary-row{ flex-direction:column; gap:8px; align-items:center; }
      .status-btn,.liberar-btn{ min-width:120px; padding:10px 12px; }
      .wa, .charge{ width:38px; height:38px; }
      .wa img, .charge img{ width:26px; height:26px; }
    }
  </style>
</head>
<body>
  <div class="loader" id="loader"><div class="spinner" aria-label="Cargando"></div></div>
  <div class="container">
    <h1>BALANCE RIFA</h1>

    <!-- Recuadro centrado con la cantidad total y filtro -->
    <div class="summary-wrap" aria-live="polite">
      <div class="summary-row">
        <div class="selected-group" aria-hidden="false">
          <div id="selectedBox" class="selected-badge" style="display:none"></div>
          <div id="selectedCaption" class="summary-caption" style="display:none">N° Seleccionados</div>
        </div>

        <input id="filterInput" class="filter-input" type="text" placeholder="escribe para filtrar" aria-label="Filtrar por nombre, números, teléfono o estado">
      </div>
    </div>

    <div id="list"></div>
    <div class="save-wrap">
      <button id="save" class="save-btn" disabled>Guardar Cambios</button>
    </div>
  </div>

  <script>
    // Endpoint de tu implementación (GET/POST)
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyG9uHwWUzawyQ7p4vXQwtcq8D72WUhGwSGersAoydj5x_TSBkhpCKqStMBkqPduZpF/exec';
    const SEPARATOR = ', ';

    const SOUNDS = {
      question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
      info:     'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
      success:  'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
      error:    'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
      warning:  'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3'
    };
    function play(url){ try{ new Audio(url).play().catch(()=>{}); }catch(_){} }

    if (window.Swal && typeof Swal.fire === 'function'){
      const __fire = Swal.fire.bind(Swal);
      Swal.fire = function(options = {}, ...rest){
        try{
          const icon = options.icon || options.type;
          if (icon && SOUNDS[icon]) play(SOUNDS[icon]);
        }catch(e){}
        return __fire(options, ...rest);
      }
    }

    const $loader = document.getElementById('loader');
    let loadingCount = 0, loaderTimer = null;
    function startLoading(){
      loadingCount++;
      if(loadingCount === 1){
        loaderTimer = setTimeout(()=>{ $loader.classList.add('active'); loaderTimer=null; }, 120);
      }
    }
    function stopLoading(){
      if(loadingCount === 0) return;
      loadingCount--;
      if(loadingCount === 0){
        if(loaderTimer){ clearTimeout(loaderTimer); loaderTimer=null; }
        $loader.classList.remove('active');
      }
    }

    async function apiGet(action, params = {}){
      startLoading();
      try{
        const url = new URL(API_BASE);
        url.search = new URLSearchParams({ action, ...params }).toString();
        const r = await fetch(url.toString(), { method:'GET', headers:{ 'Accept':'application/json' } });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Error');
        return j.data;
      } finally { stopLoading(); }
    }
    async function apiPost(action, body = {}){
      startLoading();
      try{
        const url = API_BASE + '?action=' + encodeURIComponent(action);
        const r = await fetch(url, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8', 'Accept':'application/json' }, body: JSON.stringify(body) });
        const j = await r.json();
        if(!j.ok) throw new Error(j.error || 'Error');
        return j.data;
      } finally { stopLoading(); }
    }

    // UI elements
    const $list = document.getElementById('list');
    const $save = document.getElementById('save');
    const $selectedBox = document.getElementById('selectedBox');
    const $selectedCaption = document.getElementById('selectedCaption');
    const $filterInput = document.getElementById('filterInput');

    let DATA = [];
    const PENDING = new Map(); // row -> 'PAGO'|'PENDIENTE'

    // Convert keycap digits to normal digits
    function normalizeKeycapDigits(s){
      if(!s) return '';
      const map = {'0️⃣':'0','1️⃣':'1','2️⃣':'2','3️⃣':'3','4️⃣':'4','5️⃣':'5','6️⃣':'6','7️⃣':'7','8️⃣':'8','9️⃣':'9'};
      let out = String(s);
      for(const k in map){ out = out.split(k).join(map[k]); }
      out = out.replace(/([0-9])\uFE0F\u20E3/g, '$1');
      return out;
    }
    function parseNumbersFromCell(raw){
      const plain = normalizeKeycapDigits(String(raw||''));
      return plain.split(/[^0-9]+/).filter(Boolean);
    }

    // Update summary based on the list currently rendered (visible)
    function updateSelectedSummary(list){
      if(!Array.isArray(list) || list.length === 0){
        $selectedBox.style.display = 'none';
        $selectedCaption.style.display = 'none';
        $selectedBox.textContent = '';
        return;
      }
      let total = 0;
      for(const it of list) total += parseNumbersFromCell(it.numeros).length;

      $selectedBox.textContent = String(total);
      $selectedBox.style.display = 'inline-block';
      $selectedCaption.style.display = 'block';
    }

    function chipify(numerosRaw){
      const nums = parseNumbersFromCell(numerosRaw);
      const frag = document.createDocumentFragment();
      nums.forEach((n, i) => {
        const s = document.createElement('span');
        s.className = 'num-chip';
        s.textContent = n;
        frag.appendChild(s);
        if(i < nums.length - 1){
          const sep = document.createElement('span');
          sep.className = 'num-sep';
          sep.textContent = SEPARATOR;
          frag.appendChild(sep);
        }
      });
      return frag;
    }

    function statusClass(estado){
      const e = String(estado || '').trim().toUpperCase();
      return (e === 'PAGO' || e === 'PAGÓ' || e === 'PAGADO') ? 'status-paid' : 'status-pending';
    }

    function firstNameOf(fullName){
      const name = String(fullName||'').trim();
      if(!name) return '';
      const first = name.split(/\s+/)[0];
      return first.charAt(0).toUpperCase() + first.slice(1).toLowerCase();
    }

    function buildChargeMessage(item){
      const nombre = firstNameOf(item.nombre || '');
      const numeros = parseNumbersFromCell(item.numeros).join(SEPARATOR);
      return `Hola ${nombre} ¿Cómo estás?

Quería recordarte el sorteo de la rifa y el pago de tu(s) número(s): ${numeros}

Quedamos atentos, mil gracias por la colaboración`;
    }

    function createCard(item){
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.row = item.row;

      const top = document.createElement('div');
      top.className = 'row';
      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = item.nombre || '—';
      const dt = document.createElement('div');
      dt.className = 'datetime';
      dt.textContent = item.fechaHora || '';
      top.appendChild(name); top.appendChild(dt);

      const nums = document.createElement('div');
      nums.className = 'nums';
      nums.appendChild(chipify(item.numeros));

      const acts = document.createElement('div');
      acts.className = 'actions';

      const btnStatus = document.createElement('button');
      btnStatus.className = 'status-btn ' + statusClass(item.estado);
      btnStatus.addEventListener('click', () => {
        const isPaid = btnStatus.classList.contains('status-paid');
        btnStatus.classList.toggle('status-paid', !isPaid);
        btnStatus.classList.toggle('status-pending', isPaid);
        const newEstado = (!isPaid ? 'PAGO' : 'PENDIENTE');
        PENDING.set(item.row, newEstado);
        $save.disabled = PENDING.size === 0;
        play(SOUNDS.info);
      });

      const btnLiberar = document.createElement('button');
      btnLiberar.className = 'liberar-btn';
      btnLiberar.textContent = 'LIBERAR';
      btnLiberar.addEventListener('click', async () => {
        const numsList = parseNumbersFromCell(item.numeros).join(SEPARATOR);
        const nombre = item.nombre || '—';

        const rs = await Swal.fire({
          icon: 'question',
          title: '¿Liberar números?',
          html: `
            <div style="text-align:left;line-height:1.4;">
              <div style="margin-bottom:6px;"><b>${nombre}</b></div>
              <div>Se liberarán: <b>${numsList || '(sin números)'}</b></div>
              <div style="margin-top:6px;">Se eliminará este registro.</div>
            </div>
          `,
          showCancelButton: true,
          confirmButtonText: 'Sí, liberar',
          cancelButtonText: 'Cancelar',
          confirmButtonColor: '#16a34a',
          cancelButtonColor: '#dc2626',
          focusCancel: true
        });
        if(!rs.isConfirmed) return;

        try{
          await apiPost('liberar', { row: item.row });
          await Swal.fire({
            icon:'success',
            title:'Liberado',
            text:'Números marcados como DISPONIBLE y registro eliminado.',
            timer:1600,
            showConfirmButton:false
          });
          await listar();
        }catch(e){
          Swal.fire({ icon:'error', title:'No se pudo liberar', text: e.message || 'Error desconocido' });
        }
      });

      const digits = String(item.phone||'').replace(/\D/g,'');
      const full = digits ? (digits.startsWith('57') ? digits : ('57' + digits.slice(-10))) : '';

      const charge = document.createElement('a');
      charge.className = 'charge';
      charge.setAttribute('aria-label','Cobrar por WhatsApp');
      const chargeImg = document.createElement('img');
      chargeImg.alt='Cobrar';
      chargeImg.src='https://res.cloudinary.com/dqqeavica/image/upload/v1760575142/cobrar_cllc9l.webp';
      charge.appendChild(chargeImg);

      if(full){
        const msg = buildChargeMessage(item);
        charge.href = 'https://wa.me/' + full + '?text=' + encodeURIComponent(msg);
        charge.target = '_blank'; charge.rel = 'noopener';
      }else{
        charge.href='javascript:void(0)'; charge.style.opacity=.45;
      }

      const wa = document.createElement('a');
      wa.className = 'wa';
      if(full){
        wa.href = 'https://wa.me/' + full;
        wa.target = '_blank'; wa.rel = 'noopener';
      }else{
        wa.href='javascript:void(0)'; wa.style.opacity=.45;
      }
      const img = document.createElement('img');
      img.alt='WhatsApp';
      img.src='https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp';
      wa.appendChild(img);

      const icons = document.createElement('div');
      icons.className = 'actions-right';
      icons.appendChild(charge);
      icons.appendChild(wa);

      acts.appendChild(btnStatus);
      acts.appendChild(btnLiberar);
      acts.appendChild(icons);

      card.appendChild(top);
      card.appendChild(nums);
      card.appendChild(acts);
      return card;
    }

    function render(list){
      $list.innerHTML = '';
      if(!list?.length){
        const p = document.createElement('p');
        p.textContent = 'Sin registros';
        p.style.textAlign='center'; p.style.color='#444';
        $list.appendChild(p);
        return;
      }
      for(const it of list) $list.appendChild(createCard(it));
    }

    // Search helpers
    function normalizeForSearch(s){
      return String(s||'').toLowerCase();
    }
    function phoneDigits(s){
      return String(s||'').replace(/\D/g,'');
    }

    function matchesFilter(item, qRaw){
      if(!qRaw) return true;
      const q = normalizeKeycapDigits(String(qRaw)).toLowerCase().trim();
      if(!q) return true;

      // name
      const name = normalizeForSearch(item.nombre);
      if(name.includes(q)) return true;

      // estado
      const estado = normalizeForSearch(item.estado);
      if(estado.includes(q)) return true;

      // phone (compare numeric-only)
      const phone = phoneDigits(item.phone);
      const qDigits = q.replace(/\D/g,'');
      if(phone && qDigits && phone.includes(qDigits)) return true;
      if(phone && q && phone.includes(q)) return true;

      // numeros (raw normalized)
      const numerosRaw = normalizeKeycapDigits(String(item.numeros||'')).toLowerCase();
      if(numerosRaw.includes(q)) return true;

      // individual number match
      const nums = parseNumbersFromCell(item.numeros).map(n=>String(n).toLowerCase());
      for(const n of nums){
        if(n.includes(q)) return true;
        if(qDigits && n.includes(qDigits)) return true;
      }

      return false;
    }

    async function load(){
      try{
        const data = await apiGet('listcomprados');
        return data;
      }catch(e){
        Swal.fire({ icon:'error', title:'Error al cargar', text:e.message });
        return [];
      }
    }

    // Listar y aplicar filtro actual
    async function listar(){
      DATA = await load();
      PENDING.clear();
      $save.disabled = true;
      const q = $filterInput.value || '';
      const filtered = DATA.filter(item => matchesFilter(item, q));
      render(filtered);
      updateSelectedSummary(filtered);
    }
    window.listar = listar;

    document.addEventListener('DOMContentLoaded', listar);

    document.getElementById('save').addEventListener('click', async ()=>{
      if(PENDING.size===0) return;
      const cambios = [];
      for(const [row, estado] of PENDING.entries()) cambios.push({row, estado: String(estado||'').toUpperCase()});
      try{
        await apiPost('guardarEstados', { cambios });
        await Swal.fire({ icon:'success', title:'Cambios guardados', timer:1400, showConfirmButton:false });
        PENDING.clear();
        $save.disabled = true;
        await listar();
      }catch(e){
        Swal.fire({ icon:'error', title:'No se pudo guardar', text:e.message });
      }
    });

    // Debounced live filter
    function debounce(fn, wait=200){
      let t;
      return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), wait); };
    }

    const applyFilter = debounce(() => {
      const q = $filterInput.value || '';
      const filtered = DATA.filter(item => matchesFilter(item, q));
      render(filtered);
      updateSelectedSummary(filtered);
    }, 120);

    $filterInput.addEventListener('input', applyFilter);
  </script>
</body>
</html>
